<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>draw</title>
</head>

<body oncontextmenu='self.event.returnvalue=false'>
    <button onclick="flag=0">画圆</button>
    <button onclick="flag=1">画矩形</button>
    <button onclick="flag=2">画多边形</button>(最多8条边，右键取消，10px内自动闭合)
    <button onclick="clearAll()">清除</button> <br><br>
    <canvas id="canvas" width="500px" height="500px" style="border: 1px solid black"></canvas>



    <script>
        var canvas = document.getElementById('canvas');
        var ctx = canvas.getContext('2d');
        document.oncontextmenu = new Function("event.returnValue=false;");
        document.onselectstart = new Function("event.returnValue=false;");
        var flag = 1;
        var rect = [];
        var rectNum = 0;
        var circle = [];
        var circleNum = 0;
        var polygon = [];
        var polygonNum = 0;
        var point = [];
        var pointNum = 0;
        var pointObj = {
            x: 0,
            y: 0
        }
        canvas.onmousedown = function (e1) {
            if (flag == 1 && e1.which == 1) {
                //creat rect
                rect[rectNum] = new Rect(e1.clientX - canvas.offsetLeft, e1.clientY - canvas.offsetTop, 0, 0)
                canvas.onmousemove = function (e2) {
                    ctx.clearRect(0, 0, 800, 800);
                    ctx.strokeRect(e1.clientX - canvas.offsetLeft, e1.clientY - canvas.offsetTop, e2.clientX -
                        e1.clientX, e2.clientY - e1.clientY);
                    drawAll();
                    rect[rectNum].w = e2.clientX - e1.clientX;
                    rect[rectNum].h = e2.clientY - e1.clientY;
                }
                canvas.onmouseup = function () {
                    canvas.onmousemove = '';
                    canvas.onmouseup = '';
                    rectNum++;
                    drawAll();
                }
            } else if (flag == 0 && e1.which == 1) {
                //creat circle
                circle[circleNum] = new Circle(e1.clientX - canvas.offsetLeft, e1.clientY - canvas.offsetTop, 0)
                canvas.onmousemove = function (e2) {
                    ctx.clearRect(0, 0, 800, 800);
                    ctx.beginPath();
                    ctx.arc(e1.clientX - canvas.offsetLeft, e1.clientY - canvas.offsetTop, Math.abs(e2.clientX -
                        e1.clientX), Math.PI * 2, 0);
                    ctx.stroke();
                    ctx.closePath();
                    drawAll();
                    circle[circleNum].r = Math.abs(e2.clientY - e1.clientY);
                }
                canvas.onmouseup = function () {
                    canvas.onmousemove = '';
                    canvas.onmouseup = '';
                    circleNum++;
                    drawAll();
                }
            } else if (e1.which == 1) {
                console.log(polygon)
                point[pointNum] = {
                    x: e1.clientX - canvas.offsetLeft,
                    y: e1.clientY - canvas.offsetTop
                };
                pointNum++;
                drawPolygon();
                canvas.onmousemove = function (e2) {
                    ctx.clearRect(0, 0, 800, 800);
                    drawAll();
                    drawPolygon();
                    ctx.beginPath();
                    ctx.moveTo(e1.clientX - canvas.offsetLeft, e1.clientY - canvas.offsetTop);
                    ctx.lineTo(e2.clientX - canvas.offsetLeft, e2.clientY - canvas.offsetTop);
                    ctx.stroke();
                    ctx.closePath();
                    document.onmousedown = function (e3) {
                        if (e3.which == 3) {
                            point = [];
                            pointNum = 0;
                            canvas.onmousemove = '';
                            drawAll();
                        }
                    }
                }
                if (pointNum > 8) {
                    alert('超过了边数限制,请重新画');
                    point = [];
                    pointNum = 0;
                    canvas.onmousemove = '';
                    drawAll();
                }
                if (pointNum >= 3 && Math.abs(point[0].x - point[pointNum - 1].x) <= 10 && Math.abs(point[0].y -
                        point[pointNum - 1].y) <= 10) {
                    polygon[polygonNum] = point;
                    polygonNum++;
                    point = [];
                    pointNum = 0;
                    canvas.onmousemove = '';
                    drawAll();
                }
            }
        }

        function drawAll() {
            ctx.clearRect(0, 0, 800, 800);
            for (i in rect) {
                ctx.strokeRect(rect[i].x, rect[i].y, rect[i].w, rect[i].h);
                ctx.strokeText('矩形' + i, rect[i].x, rect[i].y + 10);
            }
            for (i in circle) {
                ctx.beginPath();
                ctx.arc(circle[i].x, circle[i].y, circle[i].r, Math.PI * 2, 0);
                ctx.stroke();
                ctx.closePath();
                ctx.strokeText('圆' + i, circle[i].x, circle[i].y + 20);
            }
            for (i in polygon) {
                ctx.strokeText('多' + i, polygon[i][0].x, polygon[i][0].y);
                if (polygon.length >= 1) {
                    ctx.beginPath();
                    ctx.moveTo(polygon[i][0].x, polygon[i][0].y);
                    for (var j = 1; j < polygon[i].length - 1; j++) {
                        ctx.lineTo(polygon[i][j].x, polygon[i][j].y);
                    }
                    ctx.lineTo(polygon[i][0].x, polygon[i][0].y);
                    ctx.stroke();
                    ctx.closePath();
                }
            }
        }

        function drawPolygon() {
            if (point.length >= 2) {
                for (var i = 0; i < point.length - 1; i++) {
                    console.log(typeof (point[i].x))
                    ctx.beginPath();
                    ctx.moveTo(point[i].x, point[i].y);
                    ctx.lineTo(point[i + 1].x, point[i + 1].y);
                    ctx.stroke();
                    ctx.closePath();
                }
            }
        }

        function clearAll() {
            rect = [];
            circle = [];
            rectNum = 0;
            circleNum = 0;
            polygon = [];
            polygonNum = 0;
            point = [];
            pointNum = 0;
            drawAll();
        }

        function Rect(x, y, w, h) {
            this.x = x;
            this.y = y;
            this.w = w;
            this.h = h;
        }

        function Circle(x, y, r) {
            this.x = x;
            this.y = y;
            this.r = r;
        }
        // draw();
    </script>
</body>

</html>